/*
 Will Stevens, August 2024
 
 Routines for processing cubic volumes of the Herculanium Papyri.
  
 Released under GNU Public License V3
*/


#include <stdint.h>
#include <math.h>
#include <string.h>
#include <dirent.h>

#include "tiffio.h"

#include "zarr_c64i1b64.c"
#include "bigpatch.cpp"

#undef SHOW_BAD_PATCHES

int badPatches[] = {
10762,
222680,
6117,
8054,
18080,
30463,
136310,
362813,
7128,
28326,
59988,
68281,
184590,
235434,
3999,
6804,
7751,
10399,
28804,
33605,
44242,
44450,
63609,
128568,
185147,
186715,
228515,
243284,
244877,
256118,
7205,
7495,
10022,
14287,
33327,
34531,
53423,
62209,
80509,
96909,
104958,
120512,
139372,
188434,
189439,
335150,
339980,
340648,
582,
3086,
10904,
12950,
15791,
16342,
17694,
20582,
20926,
21225,
31732,
33713,
40109,
40364,
54308,
58107,
63104,
70917,
74883,
78005,
88075,
104219,
118339,
122621,
145772,
153535,
185684,
253646,
263809,
267064,
302934,
779,
2587,
7410,
7733,
11215,
16865,
21310,
28247,
31224,
31914,
55754,
58738,
67454,
75639,
75781,
76774,
77709,
89762,
90970,
93014,
94586,
110553,
115324,
126200,
127454,
134076,
145723,
163936,
172608,
203383,
208588,
214719,
246180,
247189,
252055,
279966,
303945,
305159,
306174,
310998,
316324,
321129,
330302,
334700,
336678,
358334,
360464,
6011,
10554,
656,
1005,
5925,
6183,
6574,
7386,
7788,
8215,
13423,
14361,
14850,
15713,
18824,
19432,
19509,
20800,
21400,
25355,
25418,
25812,
26981,
30496,
32666,
33603,
34571,
43978,
47808,
49420,
51085,
51714,
53693,
61974,
73184,
77603,
82139,
84327,
86426,
87968,
104206,
111391,
114858,
116410,
116786,
122334,
123335,
123700,
127381,
134203,
134298,
140538,
154863,
155137,
160401,
161550,
164142,
179582,
180237,
180775,
181075,
181804,
182940,
193042,
199609,
206475,
216774,
221127,
221310,
228131,
231009,
239097,
242710,
246353,
246968,
254828,
255762,
259184,
269434,
305190,
321834,
333509,
348331,
7892,
32602,
113294,
327042,
223,
5000,
5822,
5911,
7465,
8167,
8272,
10908,
11902,
12644,
12780,
13640,
15180,
15346,
15952,
17780,
18588,
18919,
22127,
22473,
23949,
26233,
26471,
29354,
30252,
30871,
31256,
35116,
35187,
35873,
42390,
42434,
45748,
49373,
50467,
52663,
56234,
56451,
57830,
58611,
62526,
65807,
73445,
77597,
79198,
82831,
97976,
99149,
107539,
107556,
116493,
129353,
142542,
148083,
150240,
154011,
160504,
160699,
168222,
171352,
175159,
189599,
191034,
191992,
195792,
196871,
210176,
215022,
215828,
219842,
220855,
223305,
230279,
236302,
238832,
240920,
250718,
255030,
262400,
265241,
269686,
279605,
297074,
303795,
314200,
321528,
324436,
325637,
339556,
342200,
350928,
359695,
1203,
55477,
56088,
72808,
93833,
95817,
105367,
128474,
190272,
264298,
267568,
313553,
339087,
91330,
100413,
590,
1675,
2534,
5190,
5607,
6044,
6608,
7299,
7581,
7606,
8111,
9952,
10004,
10011,
11120,
11122,
13637,
15417,
17456,
18162,
19522,
19981,
21311,
23163,
26178,
26371,
28437,
31677,
36258,
37318,
38995,
40911,
44787,
45991,
48573,
51793,
53958,
54338,
55331,
60066,
62393,
62625,
63977,
64345,
68587,
68909,
72827,
73397,
74902,
75578,
78864,
79486,
80656,
81949,
85077,
85162,
85195,
89498,
92340,
94294,
97325,
97665,
98265,
99624,
100407,
108279,
108529,
111077,
112874,
114920,
117043,
119103,
119702,
121761,
121792,
127251,
130092,
131336,
131909,
135312,
141490,
142192,
144966,
148507,
151115,
154025,
155821,
158965,
159297,
166470,
173176,
176545,
179245,
180512,
184808,
190015,
193291,
198815,
200943,
201228,
201372,
203027,
203283,
217765,
219522,
222141,
225445,
225598,
245176,
252659,
265185,
271447,
275899,
283323,
288260,
298188,
303505,
315919,
319249,
320223,
326625,
332671,
335807,
346690,
354092,
359627,
366517,
134925,
162672,
323396,
3262,
6364,
22037,
25958,
29293,
32157,
36075,
40809,
46375,
46741,
58367,
64165,
68521,
72836,
75245,
75837,
76009,
77773,
91337,
94109,
96262,
96869,
116031,
117168,
120896,
146490,
150407,
152420,
166209,
168274,
175122,
203164,
224447,
225342,
239259,
257153,
266986,
273624,
301871,
350106,
4598,
6989,
75981,
97854,
102264,
144797,
254770,
267884,
73,
135,
1303,
1962,
2016,
2963,
5042,
5069,
5567,
6000,
6502,
7329,
8679,
9043,
9585,
11108,
11273,
12496,
13042,
13172,
13587,
15580,
15741,
16504,
17692,
18633,
19012,
19238,
19378,
20214,
20510,
22801,
23020,
23219,
23394,
23470,
24839,
24969,
27684,
28137,
29252,
29647,
30216,
30948,
33152,
34789,
34831,
35175,
36539,
38790,
39751,
39833,
41674,
42485,
44129,
45317,
47087,
47719,
52168,
52205,
53628,
57661,
60654,
61093,
61305,
61870,
64576,
66015,
66981,
68457,
69056,
77157,
79751,
79758,
80239,
80712,
82937,
83133,
86993,
90910,
91916,
93353,
96145,
99206,
100829,
104722,
105450,
105782,
106343,
111261,
112574,
112960,
114689,
121223,
121662,
122855,
122906,
124024,
125083,
130097,
131535,
131804,
131857,
138614,
139844,
140796,
142969,
144660,
145333,
148987,
153603,
156276,
158323,
159040,
159337,
160418,
162646,
163466,
167283,
172611,
178209,
186358,
191673,
193521,
195158,
197330,
202070,
202984,
203971,
212071,
215782,
220388,
225310,
229816,
230675,
231427,
231610,
236786,
237663,
242610,
264487,
265890,
269407,
270743,
271153,
274064,
280257,
286631,
288880,
292645,
300959,
308375,
310153,
313235,
313297,
326591,
327226,
329684,
332014,
338967,
343325,
352018,
363575,
76381,
184088,
12207,
14920,
18920,
43610,
56790,
102709,
103191,
103203,
109837,
120479,
121421,
136128,
218827,
310880,
185,
847,
1879,
2254,
3305,
3569,
6638,
6800,
7477,
8693,
9315,
11155,
11193,
11340,
11358,
20594,
28103,
31940,
32477,
47358,
48304,
58650,
59956,
64720,
65959,
74193,
75435,
91919,
92792,
93179,
93565,
95824,
129351,
136508,
137517,
151641,
158320,
158606,
176787,
179294,
181764,
182446,
195482,
214790,
215520,
218431,
223375,
223458,
236486,
237524,
237675,
247875,
258421,
258728,
262082,
271996,
274931,
295367,
297186,
307768,
313610,
337342,
353246,
358229,
7661,
9926,
15965,
21982,
39472,
67778,
81983,
126335,
130522,
148870,
153866,
164708,
208445,
218114,
300060,
317899,
321695,
364565,
7072,
8899,
146878,
193895,
285126,
7422,
682,
5437,
7678,
9014,
9806,
10239,
11899,
13976,
14115,
15215,
15932,
16225,
22170,
22429,
23424,
24110,
24147,
24785,
25024,
25169,
25193,
25951,
26087,
26700,
26991,
29933,
32508,
33091,
34326,
36422,
37309,
40172,
41006,
43150,
44453,
44574,
45426,
45551,
46141,
46922,
48425,
50287,
51217,
54656,
54764,
57588,
58600,
60146,
64301,
65956,
66911,
66927,
67016,
67753,
67998,
69924,
70727,
72160,
72390,
73541,
73889,
75174,
81108,
82606,
83020,
85908,
92855,
93905,
97903,
100336,
100369,
105081,
106274,
106460,
109598,
110188,
110641,
110794,
113192,
113956,
115328,
118953,
119968,
123327,
123414,
125444,
125673,
128615,
128803,
128970,
130023,
130795,
132301,
135393,
135950,
144337,
148509,
150883,
151950,
154146,
154444,
155669,
157154,
157340,
158643,
160362,
160618,
161585,
163651,
164938,
170978,
171712,
177317,
178392,
178626,
179087,
180896,
189756,
190089,
190357,
197319,
204246,
210215,
210452,
210566,
221717,
221817,
234293,
236700,
237160,
238437,
241809,
244580,
244913,
246122,
252481,
262818,
264673,
281762,
283690,
287534,
287578,
296770,
303324,
307782,
308785,
310551,
311097,
316501,
317882,
324515,
336080,
338238,
340444,
344367,
349271,
349500,
352232,
357757,
363885,
13257,
317,
123067,
129766,
179362,
278478,
46862,
81458,
106533,
152132,
311596,
2783,
18326,
22449,
74022,
91001,
115171,
123030,
133660,
167536,
193602,
232333,
252389,
270404,
272244,
278743,
301214,
329942,
21505,
27713,
47686,
91136,
102346,
546,
746,
2330,
3603,
4227,
4473,
5605,
10299,
11174,
15593,
18044,
21351,
22969,
25683,
29105,
29558,
29640,
39515,
48057,
63444,
68430,
81148,
82346,
83881,
125532,
127191,
131499,
134979,
170193,
177310,
179956,
189032,
190258,
192044,
192551,
195948,
251036,
271516,
278654,
304743,
325607,
342862,
362503,
40926,
66660,
146881,
2206,
16826,
33145,
49938,
82326,
84495,
99019,
103271,
115151,
143641,
144346,
144451,
158647,
159761,
181267,
183245,
191492,
192031,
249198,
276136,
299052,
65859,
138040,
234552,
239727,
310150,
26399,
37814,
904,
2261,
3099,
3634,
4665,
4990,
5099,
5848,
10465,
12837,
13980,
17461,
18601,
21382,
21999,
23330,
23964,
24070,
26476,
27651,
29266,
33934,
34969,
35276,
37319,
44119,
48838,
51195,
51557,
51647,
52695,
54807,
56684,
60010,
60360,
65117,
66137,
71715,
82699,
92244,
94455,
95775,
100690,
101335,
103024,
103125,
105948,
108264,
112024,
113574,
114448,
114908,
115302,
117710,
118513,
118622,
120956,
124508,
136540,
140198,
141584,
145598,
146217,
148824,
154337,
154522,
171121,
174126,
180736,
184194,
185181,
190481,
193444,
193691,
193702,
193872,
194030,
203524,
204766,
207243,
208809,
210960,
212272,
215225,
220409,
229641,
229924,
230024,
231615,
233163,
234757,
241954,
242088,
250092,
257828,
259822,
269375,
271189,
271908,
276338,
279995,
284668,
285506,
286695,
290084,
291228,
299765,
307096,
308380,
317629,
318244,
318407,
320395,
324916,
331751,
331967,
332078,
338545,
341751,
345371,
364886,
	-1};

bool IsBadPatch(int p)
{
	for(int i = 0; badPatches[i] != -1; i++)
	{
		if (p==badPatches[i]) return true;
	}
	
	return false;
}


typedef struct __attribute__((packed)) {float x,y,px,py,pz;} gridPointStruct;

ZARR_c64i1b64 *za;

int xcoord,ycoord,zcoord,width,height;

unsigned char *pointBuffer;

void render(char *fname)
{		
    int8_t vfi[4];
	
	if (1==1)
	{
		TIFF *tif = TIFFOpen(fname,"w");
		
		if (tif)
		{
			tdata_t buf;
			uint32_t row;
			
			TIFFSetField(tif, TIFFTAG_IMAGEWIDTH, width); 
			TIFFSetField(tif, TIFFTAG_IMAGELENGTH, height); 
			TIFFSetField(tif, TIFFTAG_BITSPERSAMPLE, 8); 
			TIFFSetField(tif, TIFFTAG_SAMPLESPERPIXEL, 3); 
			TIFFSetField(tif, TIFFTAG_ROWSPERSTRIP, height);   
			TIFFSetField(tif, TIFFTAG_ORIENTATION, ORIENTATION_TOPLEFT);
			TIFFSetField(tif, TIFFTAG_PLANARCONFIG, PLANARCONFIG_CONTIG);
			TIFFSetField(tif, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_RGB);
			TIFFSetField(tif, TIFFTAG_SAMPLEFORMAT, SAMPLEFORMAT_UINT);
			TIFFSetField(tif, TIFFTAG_COMPRESSION, COMPRESSION_NONE);
			
			buf = _TIFFmalloc(width*3);
			for(row=0; row<height;row++)
			{
				for(int i=0; i<width; i++)
				{
				    ZARRReadN_c64i1b64(za,zcoord,ycoord+row,xcoord+i,0,4,vfi);
					//unsigned char pixel = sqrt(vfi[0]*vfi[0]+vfi[1]*vfi[1]+vfi[2]*vfi[2]);
				   //((uint8_t *)buf)[i] = pixel;
				   ((uint8_t *)buf)[3*i] = (vfi[0]+128)*2/3;
				   ((uint8_t *)buf)[3*i+1] = (vfi[1]+128)*2/3;
				   ((uint8_t *)buf)[3*i+2] = (vfi[2]+128)*2/3;
				   
				   //overwrite if pointbuffer has something
				   if (pointBuffer[i+row*width] != 0)
				   {
					   int ci = pointBuffer[i+row*width];
				       ((uint8_t *)buf)[3*i] = 255-80*(ci%3)-(ci/105)%79;
				       ((uint8_t *)buf)[3*i+1] = 255-40*((3*ci)%5)-(ci/105)%37;
				       ((uint8_t *)buf)[3*i+2] = 255-26*((5*ci)%7)-(ci/105)%23;
#ifdef SHOW_BAD_PATCHES
				       ((uint8_t *)buf)[3*i] = 255;
				       ((uint8_t *)buf)[3*i+1] = 150;
				       ((uint8_t *)buf)[3*i+2] = 150;
#endif
				   }
				}
				TIFFWriteScanline(tif,buf,row,0);
			}
			_TIFFfree(buf);
		}
		
		TIFFClose(tif);

	}
}

int main(int argc, char *argv[])
{
	if (argc < 8)
	{
		printf("Usage: zarr_show <zarr file> <x> <y> <z> <w> <h> <tiff file> [pointset (.csv or .bp)]\n");
		printf("Show a slice from a zarr file, with optional points from pointset plotted (those that lie in the slice)\n");
		return -1;
	}
	
	xcoord = atoi(argv[2]);
	ycoord = atoi(argv[3]);
	zcoord = atoi(argv[4]);
	width = atoi(argv[5]);
	height = atoi(argv[6]);
	
	pointBuffer = (unsigned char *)malloc(width*height);
	memset(pointBuffer,0,width*height);
	
	if (!pointBuffer)
	{
		printf("Unable to allocate memory for pointBuffer");
		exit(-1);
	}
	
	if (argc>=9)
	{
	  for(int i = 8; i<argc; i++)
	  {
		if (strlen(argv[i])>4 && !strcmp(argv[i]+strlen(argv[i])-4,".csv"))
		{
			FILE *f = fopen(argv[i],"r");
			float x,y,z;
			
			while (fscanf(f,"%f,%f,%f",&x,&y,&z)==3)
			{
				if ((int)z == zcoord && (int)x>=xcoord && (int)x<xcoord+width && (int)y>=ycoord && (int)y<ycoord+height)
				{
	//				printf("Added %d,%d to pointBuffer\n",((int)x-xcoord),((int)y-ycoord));
					pointBuffer[((int)x-xcoord)+((int)y-ycoord)*width] = i-7;
				}
			}
			
			fclose(f);
		}
		else if (strlen(argv[i])>4 && !strcmp(argv[i]+strlen(argv[i])-4,".bin"))
		{
			FILE *f = fopen(argv[i],"r");
			gridPointStruct p;

			if (f)
			{
				fseek(f,0,SEEK_END);
				long fsize = ftell(f);
				fseek(f,0,SEEK_SET);
	  
				// input in x,y,z order 
				while(ftell(f)<fsize)
				{
					fread(&p,sizeof(p),1,f);
					float x,y,px,py,pz;
					x=p.x;y=p.y;px=p.px;py=p.py;pz=p.pz;
					
					if ((int)pz == zcoord && (int)px>=xcoord && (int)px<xcoord+width && (int)py>=ycoord && (int)py<ycoord+height)
					{
						printf("Added %d,%d to pointBuffer\n",((int)px-xcoord),((int)py-ycoord));
						
						// Thicken the line
						for(int xo=-1; xo<=1; xo++)
						for(int yo=-1; yo<=1; yo++)
						if ((int)px>=xcoord-xo && (int)px<xcoord+width-xo && (int)py>=ycoord-yo && (int)py<ycoord+height-yo)
						{
						  pointBuffer[((int)px-xcoord+xo)+((int)py-ycoord+yo)*width] = i-7;
						}
					}
				}
				
				fclose(f);
			}
			else
				printf("Failed to open %s\n",argv[8]);
		}
		else if (strlen(argv[i])>3 && !strcmp(argv[i]+strlen(argv[i])-3,".bp"))
		{
			printf("Opening bigpatch %s\n",argv[i]);
			
			BigPatch *bp = NULL;
			std::vector<chunkIndex> bpChunks;
		
			bp = OpenBigPatch(argv[i]);
			printf("A\n");
			bpChunks = GetAllPatchChunks(bp);
			printf("B\n");
		
			for(auto const &ii : bpChunks)
			{
				if (std::get<2>(ii) != zcoord/PATCH_CHUNK_SIZE)
					continue;
				printf("C\n");
				
				std::vector<gridPoint> gridPoints;
				ReadPatchPoints(bp,ii,gridPoints);
				
				for(auto const &gp : gridPoints)
				{
					int x = (int)std::get<2>(gp);
					int y = (int)std::get<3>(gp);
					int z = (int)std::get<4>(gp);
					int patch = (int)std::get<5>(gp);
#ifdef SHOW_BAD_PATCHES
					if ((int)z == zcoord && IsBadPatch(patch))
#else
					if ((int)z == zcoord && !IsBadPatch(patch))
#endif
					{
					  printf("%d,%d\n",x,y);
					  // Thicken the line
					  for(int xo=-1; xo<=1; xo++)
					  for(int yo=-1; yo<=1; yo++)
					  if ((int)x>=xcoord-xo && (int)x<xcoord+width-xo && (int)y>=ycoord-yo && (int)y<ycoord+height-yo)
					  {
					    pointBuffer[((int)x-xcoord+xo)+((int)y-ycoord+yo)*width] = patch+1;
					  }
					}
				}
			}
			
			CloseBigPatch(bp);
		}
		  
	  }
	}

	
	za = ZARROpen_c64i1b64(argv[1]);
	
	render(argv[7]);
	
	ZARRClose_c64i1b64(za);
	
	return 0;
}

